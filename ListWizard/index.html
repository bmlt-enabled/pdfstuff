<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Meeting List Generator Wizard</title>
        <script type="text/javascript">
            function findGetParameter(parameterName) {
                var result = null,
                tmp = [];
                location.search.substr(1).split("&").forEach(function (item) {
                    tmp = item.split("=");
                    if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
                return result;
            };
            
            function evaluateUI() {
                if (!findGetParameter('GIMME')) {
                    document.getElementById('throbber-container').style.display = 'none';
                    document.getElementById('pickerForm').style.display = 'block';
                    
                    if (document.getElementById('two-fold-tabloid').checked) {
                        document.getElementById('column-container').style.display = 'block';
                        document.getElementById('moreColumns').style.display = 'none';
                        document.getElementById('pages-container').style.display = 'none';
                        document.getElementById('columns-4').checked = true;
                    } else {
                        if (document.getElementById('two-fold-us-letter').checked) {
                            document.getElementById('column-container').style.display = 'none';
                            document.getElementById('pages-container').style.display = 'none';
                        } else {
                            if (document.getElementById('two-fold-us-legal').checked) {
                                document.getElementById('column-container').style.display = 'block';
                                document.getElementById('moreColumns').style.display = 'none';
                                document.getElementById('pages-container').style.display = 'none';
                                document.getElementById('columns-4').checked = true;
                            } else {
                                document.getElementById('column-container').style.display = 'block';
                                document.getElementById('moreColumns').style.display = 'block';
                                document.getElementById('pages-container').style.display = 'block';
                                if (document.getElementById('layout-chapbook').checked) {
                                    document.getElementById('bottom-container-small').style.display = 'block';
                                    document.getElementById('bottom-container-large').style.display = 'none';
                                } else {
                                    document.getElementById('bottom-container-small').style.display = 'none';
                                    document.getElementById('bottom-container-large').style.display = 'block';
                                };
                            };
                        };
                    };
                };
            };
            
            // Load servers on page load
            window.addEventListener('DOMContentLoaded', function() {
                loadServers();
            });
            
            function loadServers() {
                const select = document.getElementById('server-select');
                
                fetch('api/config.php?action=servers')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Server returned ' + response.status);
                        }
                        return response.json();
                    })
                    .then(servers => {
                        if (!Array.isArray(servers) || servers.length === 0) {
                            throw new Error('No servers available');
                        }
                        
                        // Clear loading option
                        select.innerHTML = '<option value="">-- Select a server --</option>';
                        
                        // Add all servers (already alphabetized from backend)
                        servers.forEach(server => {
                            const option = document.createElement('option');
                            option.value = server.url;
                            option.textContent = server.name;
                            select.appendChild(option);
                        });
                        
                        console.log('Loaded ' + servers.length + ' servers');
                    })
                    .catch(error => {
                        console.error('Error loading servers:', error);
                        select.innerHTML = '<option value="">Error loading servers - please refresh</option>';
                        alert('Failed to load server list: ' + error.message + '\nPlease refresh the page.');
                    });
            }
            
            // Handle server selection
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('server-select').addEventListener('change', function() {
                    const serverUrl = this.value;
                    if (!serverUrl) {
                        document.getElementById('service-bodies-container').style.display = 'none';
                        document.getElementById('settings-container').style.display = 'none';
                        return;
                    }
                    
                    loadServiceBodies(serverUrl);
                });
            });
            
            function loadServiceBodies(serverUrl) {
                const container = document.getElementById('service-bodies-container');
                const list = document.getElementById('service-bodies-list');
                const settingsContainer = document.getElementById('settings-container');
                
                container.style.display = 'block';
                list.style.display = 'block';
                list.innerHTML = '<p style="color:#666;padding:1em;grid-column:1/-1;">Loading service bodies from server...</p>';
                settingsContainer.style.display = 'none';
                
                const formData = new FormData();
                formData.append('server_url', serverUrl);
                
                fetch('api/config.php?action=service_bodies', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server returned ' + response.status);
                    }
                    return response.json();
                })
                .then(serviceBodies => {
                    if (serviceBodies.error) {
                        throw new Error(serviceBodies.error);
                    }
                    
                    if (!Array.isArray(serviceBodies) || serviceBodies.length === 0) {
                        list.innerHTML = '<p style="color:#666;padding:1em;grid-column:1/-1;">No service bodies found on this server.</p>';
                        return;
                    }
                    
                    list.innerHTML = '';
                    console.log('Loaded ' + serviceBodies.length + ' service bodies');
                    
                    serviceBodies.forEach(sb => {
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.marginBottom = '0.3em';
                        label.style.padding = '0.2em';
                        label.style.cursor = 'pointer';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'service_bodies[]';
                        checkbox.value = sb.id;
                        checkbox.className = 'service-body-checkbox';
                        checkbox.style.marginRight = '0.5em';
                        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(sb.name));
                        
                        list.appendChild(label);
                    });
                    
                    // Add select all/none buttons
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.marginTop = '0.5em';
                    buttonContainer.style.paddingTop = '0.5em';
                    buttonContainer.style.borderTop = '1px solid #ccc';
                    buttonContainer.style.gridColumn = '1 / -1';
                    
                    const selectAllBtn = document.createElement('button');
                    selectAllBtn.type = 'button';
                    selectAllBtn.textContent = 'Select All';
                    selectAllBtn.style.marginRight = '0.5em';
                    selectAllBtn.onclick = function() {
                        document.querySelectorAll('.service-body-checkbox').forEach(cb => cb.checked = true);
                    };
                    
                    const selectNoneBtn = document.createElement('button');
                    selectNoneBtn.type = 'button';
                    selectNoneBtn.textContent = 'Select None';
                    selectNoneBtn.onclick = function() {
                        document.querySelectorAll('.service-body-checkbox').forEach(cb => cb.checked = false);
                    };
                    
                    buttonContainer.appendChild(selectAllBtn);
                    buttonContainer.appendChild(selectNoneBtn);
                    list.appendChild(buttonContainer);
                    
                    settingsContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading service bodies:', error);
                    list.innerHTML = '<p style="color:red;padding:1em;grid-column:1/-1;">Failed to load service bodies: ' + error.message + '<br>Please try selecting a different server.</p>';
                });
            }
            
            // Handle form submission
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('pickerForm');
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Validate selections
                    const serverUrl = document.getElementById('server-select').value;
                    if (!serverUrl) {
                        alert('Please select a BMLT server');
                        return false;
                    }
                    
                    const checkedBoxes = document.querySelectorAll('.service-body-checkbox:checked');
                    if (checkedBoxes.length === 0) {
                        alert('Please select at least one service body');
                        return false;
                    }
                    
                    // Show loading
                    document.getElementById('throbber-container').style.display = 'block';
                    document.getElementById('pickerForm').style.display = 'none';
                    
                    // Build form data
                    const formData = new FormData(form);
                    
                    // Add use_list=generic
                    formData.append('use_list', 'generic');
                    
                    // Submit via POST to support all parameters
                    fetch('printed_lists/index.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.blob())
                    .then(blob => {
                        // Create download link
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'meeting_list.pdf';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Hide throbber and show form again
                        document.getElementById('throbber-container').style.display = 'none';
                        document.getElementById('pickerForm').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error generating PDF:', error);
                        alert('Failed to generate PDF. Please try again.');
                        document.getElementById('throbber-container').style.display = 'none';
                        document.getElementById('pickerForm').style.display = 'block';
                    });
                    
                    return false;
                });
            });
            
            function handleGimme() {
                // This function is no longer needed as we use form submit event
                // Kept for backward compatibility with existing layout logic
            };
            
        </script>
        <style type="text/css">
            body {
                text-align:center;
                font-family:Arial,Sans-serif;
            }
            
            div.formContents {
                margin:auto;
                display:table;
            }
            
            div.layout-container {
                margin:auto;
                display:table;
                text-align:left;
                float:left;
            }
            
            div.selectionLine {
                clear:both;
                margin-top:0.25em;
                vertical-align:center;
            }
            
            div.selectionLine div.selectionBlock {
                float:left;
                display: table;
            }
            
            div.selectionBlock h4 {
                margin: 0;
                margin-bottom: 0.25em;
            }
            
            div.selectionLine div.choiceBlock {
                display: table;
                margin:auto;
            }
            
            div.choiceBlock input {
                float:left;
                margin:0;
                line-height:100%;
                margin-right: 1em;
            }
            div.choiceBlock label {
                float:left;
                display:block;
            }
            div.choiceBlock label img {
                float:left;
                display:block;
            }
            div.bottom-container {
                float:none;
                clear:both;
                display:table;
                width:auto;
                margin:auto;
                padding-top:1em;
            }
            div.bottom-container label {
                display:inline;
                margin-right: 0.5em;
            }
            div.bottom-container select {
                display:inline;
            }
        </style>
    </head>
    <body>
        <div id="throbber-container" style="display:none">
            <img src="images/throbber.gif" alt="throbber" style="position:absolute;width:190px;top:50%;left:50%;margin-top:-95px;margin-left:-95px" />
        </div>
        <form action="#" method="POST" id="pickerForm">
            <div class="formContents">
                <h1>Create A Meeting List PDF</h1>
                
                <!-- Server Selection -->
                <div class="bottom-container" style="margin-bottom:1.5em;">
                    <label for="server-select" style="display:block;margin-bottom:0.5em;font-weight:bold;">Select BMLT Server:</label>
                    <select id="server-select" name="server_url" style="width:100%;padding:0.5em;" required>
                        <option value="">-- Select a server --</option>
                    </select>
                </div>
                
                <!-- Service Bodies Selection -->
                <div id="service-bodies-container" class="bottom-container" style="display:none;margin-bottom:1.5em;">
                    <label style="display:block;margin-bottom:0.5em;font-weight:bold;">Service Bodies:</label>
                    <div id="service-bodies-list" style="max-height:200px;overflow-y:auto;border:1px solid #ccc;padding:0.5em;background:#fff;display:grid;grid-template-columns: 1fr 1fr;gap: 0.25em 1em;align-items:start;text-align:left;">
                        <p style="color:#666;">Loading...</p>
                    </div>
                    <label style="display:block;margin-top:0.5em;">
                        <input type="checkbox" name="recursive" value="1" id="recursive-checkbox" />
                        Include child service bodies
                    </label>
                </div>
                
                <!-- Settings Panel -->
                <div id="settings-container" class="bottom-container" style="display:none;margin-bottom:1.5em;">
                    <details>
                        <summary style="font-weight:bold;cursor:pointer;margin-bottom:0.5em;">Custom Settings (Optional)</summary>
                        <div style="padding:1em;border:1px solid #ddd;background:#f9f9f9;">
                            <div style="margin-bottom:0.5em;">
                                <label for="helpline" style="display:block;font-size:0.9em;">Helpline:</label>
                                <input type="text" id="helpline" name="helpline" placeholder="e.g., Helpline: (555) 123-4567" style="width:100%;padding:0.3em;" />
                            </div>
                            <div style="margin-bottom:0.5em;">
                                <label for="banner_1" style="display:block;font-size:0.9em;">Banner Line 1:</label>
                                <input type="text" id="banner_1" name="banner_1" value="NA Meetings" style="width:100%;padding:0.3em;" />
                            </div>
                            <div style="margin-bottom:0.5em;">
                                <label for="banner_2" style="display:block;font-size:0.9em;">Banner Line 2:</label>
                                <input type="text" id="banner_2" name="banner_2" placeholder="Optional" style="width:100%;padding:0.3em;" />
                            </div>
                            <div style="margin-bottom:0.5em;">
                                <label for="banner_3" style="display:block;font-size:0.9em;">Banner Line 3:</label>
                                <input type="text" id="banner_3" name="banner_3" placeholder="Optional" style="width:100%;padding:0.3em;" />
                            </div>
                            <div style="margin-bottom:0.5em;">
                                <label for="credits" style="display:block;font-size:0.9em;">Credits:</label>
                                <input type="text" id="credits" name="credits" placeholder="e.g., Printed by Your Area" style="width:100%;padding:0.3em;" />
                            </div>
                            <div style="margin-bottom:0.5em;">
                                <label for="web_url" style="display:block;font-size:0.9em;">Website URL:</label>
                                <input type="text" id="web_url" name="web_url" placeholder="e.g., https://yourarea.org" style="width:100%;padding:0.3em;" />
                            </div>
                            <div style="margin-bottom:0.5em;">
                                <label for="week_starts" style="display:block;font-size:0.9em;">Week Starts On:</label>
                                <select id="week_starts" name="week_starts" style="width:100%;padding:0.3em;">
                                    <option value="1">Sunday</option>
                                    <option value="2" selected>Monday</option>
                                </select>
                            </div>
                            <div style="margin-bottom:0.5em;">
                                <label for="group_by" style="display:block;font-size:0.9em;">Group Meetings By:</label>
                                <select id="group_by" name="group_by" style="width:100%;padding:0.3em;">
                                    <option value="weekday" selected>Day of Week (Monday, Tuesday, etc.)</option>
                                    <option value="city">City/Town</option>
                                </select>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div class="layout-container" style="text-align:center;padding:0;margin-right:1.5em">
                    <div class="selectionLine">
                        <h3>Two-Fold</h4>
                        <div class="selectionBlock" style="width:33%">
                            <h4>Tabloid</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="layout" value="two-fold-tabloid" id="two-fold-tabloid" checked="checked" onchange="evaluateUI()" />
                                <label for="two-fold-tabloid" class="thumbnail-label">
                                    <img src="images/TabloidTwoFold.png" alt="Taboid Icon" width="34px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                        <div class="selectionBlock" style="width:33%">
                            <h4>US Legal</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="layout" value="two-fold-us-legal" id="two-fold-us-legal" onchange="evaluateUI()" />
                                <label for="two-fold-us-legal" class="thumbnail-label">
                                    <img src="images/USLegalTwoFold.png" alt="US Legal Icon" height="48px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                        <div class="selectionBlock" style="width:33%">
                            <h4>US Letter</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="layout" value="two-fold-us-letter" id="two-fold-us-letter" onchange="evaluateUI()" />
                                <label for="two-fold-us-letter" class="thumbnail-label">
                                    <img src="images/USLetterTwoFold.png" alt="US Letter Icon" height="48px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="selectionLine" style="padding-top:0.5em">
                        <h3>Booklets</h4>
                        <div class="selectionBlock" style="width:50%">
                            <h4>Smaller</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="layout" value="chapbook" id="layout-chapbook" onchange="evaluateUI()" />
                                <label for="layout-chapbook" class="thumbnail-label">
                                    <img src="images/Chapbook.png" alt="Chapbook Icon" width="50px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                        <div class="selectionBlock" style="width:50%">
                            <h4>Larger</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="layout" value="booklet" id="layout-booklet" onchange="evaluateUI()" />
                                <label for="layout-booklet" class="thumbnail-label">
                                    <img src="images/Booklet.png" alt="Booklet Icon" width="50px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="column-container" class="layout-container">
                    <div class="selectionLine">
                        <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                            <h4>1 Column</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="columns" value="1" id="columns-1" />
                                <label for="columns-1" class="thumbnail-label">
                                    <img src="images/Column-1.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                        <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                            <h4>2 Columns</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="columns" value="2" id="columns-2" />
                                <label for="columns-2" class="thumbnail-label">
                                    <img src="images/Column-2.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="selectionLine">
                        <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                            <h4>3 Columns</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="columns" value="3" id="columns-3" />
                                <label for="columns-3" class="thumbnail-label">
                                    <img src="images/Column-3.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                        <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                            <h4>4 Columns</h4>
                            <div class="choiceBlock">
                                <input type="radio" name="columns" value="4" id="columns-4" checked="checked" />
                                <label for="columns-4" class="thumbnail-label">
                                    <img src="images/Column-4.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="moreColumns" style="display:none">
                        <div class="selectionLine">
                            <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                                <h4>5 Columns</h4>
                                <div class="choiceBlock">
                                    <input type="radio" name="columns" value="5" id="columns-5" />
                                    <label for="columns-5" class="thumbnail-label">
                                        <img src="images/Column-5.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                    </label>
                                </div>
                            </div>
                            <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                                <h4>6 Columns</h4>
                                <div class="choiceBlock">
                                    <input type="radio" name="columns" value="6" id="columns-6" />
                                    <label for="columns-6" class="thumbnail-label">
                                        <img src="images/Column-6.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="selectionLine">
                            <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                                <h4>7 Columns</h4>
                                <div class="choiceBlock">
                                    <input type="radio" name="columns" value="7" id="columns-7" />
                                    <label for="columns-7" class="thumbnail-label">
                                        <img src="images/Column-7.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                    </label>
                                </div>
                            </div>
                            <div class="selectionBlock" style="margin-left:1.0em;padding-top:0.25em">
                                <h4>8 Columns</h4>
                                <div class="choiceBlock">
                                    <input type="radio" name="columns" value="8" id="columns-8" />
                                    <label for="columns-8" class="thumbnail-label">
                                        <img src="images/Column-8.png" alt="US Letter Icon" width="48px" class="thumbnail" />
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bottom-container" id="pages-container" style="display:none">
                    <div id="bottom-container-small" style="display:none">
                        <label for="pages-small">Pages:</label>
                        <select name="pages-small" id="pages-select-small">
                            <option value="4" selected="selected">4</option>
                            <option value="8">8</option>
                            <option value="12">12</option>
                            <option value="16">16</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    <div id="bottom-container-large" style="display:none">
                        <label for="pages-large">Pages:</label>
                        <select name="pages-large" id="pages-select-large">
                            <option value="24" selected="selected">24</option>
                            <option value="28">28</option>
                            <option value="32">32</option>
                            <option value="36">36</option>
                            <option value="40">40</option>
                            <option value="44">44</option>
                            <option value="48">48</option>
                            <option value="52">52</option>
                            <option value="56">56</option>
                            <option value="60">60</option>
                            <option value="64">64</option>
                            <option value="68">68</option>
                            <option value="72">72</option>
                            <option value="76">76</option>
                            <option value="80">80</option>
                            <option value="84">84</option>
                            <option value="88">88</option>
                            <option value="92">92</option>
                            <option value="96">96</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <div class="bottom-container">
                    <input class="submit-button" type="submit" id="GIMME" name="GIMME" value="GIMME" />
                </div>
            </div>
        </form>
    </body>
</html>
